name: Weekly Rest Area Database Sync

on:
  # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (ë§¤ì£¼ ì›”ìš”ì¼ ìƒˆë²½ 3ì‹œ KST = ì¼ìš”ì¼ 18ì‹œ UTC)
  schedule:
    - cron: '0 18 * * 0'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Sync Type'
        required: true
        default: 'weekly'
        type: choice
        options:
          - weekly
          - official_only
          - private_only
          - manual_test

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Weekly Database Sync
        if: github.event.inputs.sync_type == 'weekly' || github.event.inputs.sync_type == '' || github.event_name == 'schedule'
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_HIGHWAY_API_KEY: ${{ secrets.HIGHWAY_API_KEY }}
          NEXT_PUBLIC_KAKAO_REST_KEY: ${{ secrets.KAKAO_REST_KEY }}
        run: |
          npm run sync:weekly
      
      - name: Run Official API Only
        if: github.event.inputs.sync_type == 'official_only'
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_HIGHWAY_API_KEY: ${{ secrets.HIGHWAY_API_KEY }}
          SYNC_TYPE: full
        run: |
          npm run sync:rest-areas
      
      - name: Run Private Highways Only
        if: github.event.inputs.sync_type == 'private_only'
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_KAKAO_REST_KEY: ${{ secrets.KAKAO_REST_KEY }}
        run: |
          npm run sync:additional
      
      - name: Run Manual Test
        if: github.event.inputs.sync_type == 'manual_test'
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_HIGHWAY_API_KEY: ${{ secrets.HIGHWAY_API_KEY }}
          NEXT_PUBLIC_KAKAO_REST_KEY: ${{ secrets.KAKAO_REST_KEY }}
        run: |
          echo "ğŸ§ª ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ëª¨ë“œ"
          npm run sync:all
      
      - name: Create weekly sync report
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const title = context.eventName === 'schedule' ? 
              'ğŸ“Š ì£¼ê°„ íœ´ê²Œì†Œ ë°ì´í„°ë² ì´ìŠ¤ ë™ê¸°í™” ë¦¬í¬íŠ¸' : 
              'ğŸ”„ íœ´ê²Œì†Œ DB ë™ê¸°í™” ê²°ê³¼';
            
            const status = '${{ job.status }}' === 'success' ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨';
            const syncType = '${{ github.event.inputs.sync_type }}' || 'weekly';
            
            const body = `## ${status} - ì£¼ê°„ DB ë™ê¸°í™”
            
            ### ğŸ“‹ ì‹¤í–‰ ì •ë³´
            - **ì‹¤í–‰ ì‹œê°„**: ${new Date().toLocaleString('ko-KR')}
            - **ë™ê¸°í™” íƒ€ì…**: ${syncType}
            - **íŠ¸ë¦¬ê±°**: ${context.eventName === 'schedule' ? 'ìë™ ìŠ¤ì¼€ì¤„' : 'ìˆ˜ë™ ì‹¤í–‰'}
            
            ### ğŸ“Š ë™ê¸°í™” ë²”ìœ„
            - âœ… **í•œêµ­ë„ë¡œê³µì‚¬ API**: ê³µì‹ íœ´ê²Œì†Œ ~203ê°œ
            - âœ… **ë¯¼ìê³ ì†ë„ë¡œ**: ì¶”ê°€ íœ´ê²Œì†Œ ~8ê°œ
            - âœ… **ë°ì´í„° ê²€ì¦**: ì¤‘ë³µ ì œê±° ë° í’ˆì§ˆ ê´€ë¦¬
            
            ### ğŸ”— ìƒì„¸ ì •ë³´
            - [ì‹¤í–‰ ë¡œê·¸ í™•ì¸](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - [íœ´ê²Œì†Œ ê´€ë¦¬ í˜ì´ì§€](http://localhost:3000/admin/db-sync)
            
            ### ğŸ’¡ ì´ìš© ì•ˆë‚´
            - í”„ë¡ íŠ¸ì—”ë“œì—ì„œëŠ” ë°ì´í„°ë² ì´ìŠ¤ì˜ ìµœì‹  ë°ì´í„°ë¥¼ ìë™ ì‚¬ìš©
            - ë‹¤ìŒ ë™ê¸°í™”: 7ì¼ í›„ ìë™ ì‹¤í–‰
            - ê²½ë¡œ ê²€ìƒ‰ ì‹œ ëª¨ë“  ë¯¼ìê³ ì†ë„ë¡œ íœ´ê²Œì†Œ í¬í•¨ë¨
            
            ${context.job.status === 'failure' ? 'âš ï¸ ë™ê¸°í™” ì‹¤íŒ¨. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.' : 'âœ… ëª¨ë“  íœ´ê²Œì†Œ ë°ì´í„°ê°€ ìµœì‹  ìƒíƒœë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.'}`;
            
            // ì‹¤íŒ¨ì‹œì—ë§Œ ì´ìŠˆ ìƒì„±
            if ('${{ job.status }}' === 'failure') {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `âŒ ${title}`,
                body: body,
                labels: ['database', 'sync-error', 'automated']
              });
            }